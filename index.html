<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경찰특공대 EOD 분석시스템</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #ffffff;
            --accent-color: #007bff;
            --background-color: #f8f9fa;
            --text-color: #212529;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "맑은 고딕", sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
        }
        
        .header {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            padding: 1rem;
            text-align: center;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .input-section {
            background-color: var(--secondary-color);
            padding: 16px;
            margin-bottom: 14px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.07);
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 10px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            min-height: 36px;
        }
        
        .results-section {
            display: none;
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .results-section.show {
            display: block;
        }
        
        .result-item {
            margin-bottom: 15px;
            padding: 15px;
            background-color: var(--background-color);
            border-radius: 4px;
        }
        
        .result-item strong {
            color: var(--accent-color);
            font-size: 1.2em;
        }

        /* 지도 관련 스타일 추가 */
        #map-container {
            margin-top: 20px;
            display: none;
        }

        #map {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .location-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            min-height: 32px;
            font-size: 15px;
            white-space: nowrap;
        }

        .circle-legend {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--background-color);
            border-radius: 4px;
        }

        .circle-legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .circle-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* 검색 컨테이너 스타일 추가 */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .search-input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        /* 탭 스타일 추가 */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }

        .tab {
            padding: 12px 24px;
            background-color: var(--background-color);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .tab.active {
            background-color: var(--primary-color);
            color: var(--secondary-color);
        }

        .tab:hover {
            background-color: #e9ecef;
        }

        .tab.active:hover {
            background-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 의심물체 분석 페이지 스타일 */
        .analysis-form {
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .analysis-item {
            background-color: var(--background-color);
            padding: 15px;
            border-radius: 4px;
        }

        .analysis-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .analysis-item select,
        .analysis-item input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* 분석 탭 이미지 업로드 섹션 스타일 */
        .image-upload-section {
            display: flex;
            gap: 20px; /* 사진 사이 간격 */
            margin-top: 15px;
        }

        .image-upload-item {
            flex: 1; /* 공간 균등 분할 */
            display: flex;
            flex-direction: column;
        }

        .image-upload-item label {
            margin-bottom: 8px;
            font-weight: bold;
        }

        .image-upload-item input[type="file"] {
            margin-bottom: 10px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 600px; /* 미리보기 최대 높이 제한 */
            height: auto;
            display: none; /* 초기에는 숨김 */
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* 반응형 */
        @media (max-width: 600px) {
            body {
                padding: 2px;
            }
            .container {
                max-width: 100vw;
                padding: 2px;
            }
            .header {
                padding: 0.5rem;
                font-size: 1.1em;
            }
            .tabs {
                margin-bottom: 10px;
            }
            .tab {
                padding: 8px 8px;
                font-size: 13px;
            }
            .tab-content {
                padding: 0;
            }
            .input-section, .results-section {
                padding: 7px 4px;
                margin-bottom: 7px;
                font-size: 13px;
            }
            h3 {
                font-size: 1em;
                margin: 8px 0 6px 0;
            }
            select, input[type="number"], input[type="text"] {
                padding: 6px;
                font-size: 13px;
                margin-bottom: 6px;
            }
            .calculate-btn {
                padding: 6px 0;
                font-size: 13px;
                min-height: 26px;
                width: 100%;
            }
            .location-btn {
                padding: 3px 5px;
                font-size: 11px;
                min-height: 18px;
                width: auto;
                white-space: nowrap;
            }
            .search-container {
                flex-wrap: wrap;
                gap: 2px;
                margin-bottom: 4px;
            }
            .search-input {
                font-size: 12px;
                padding: 5px;
            }
            .result-item {
                padding: 8px 4px;
                font-size: 13px;
            }
            .image-upload-section {
                gap: 8px;
            }
            .image-preview {
                max-width: 100vw;
                max-height: 220px;
            }
            #map {
                height: 220px;
                min-height: 120px;
            }
            .circle-legend {
                padding: 6px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>경찰특공대 EOD 분석시스템</h1>
    </div>

    <div class="container">
        <!-- 탭 버튼 -->
        <div class="tabs">
            <button class="tab active" onclick="openTab('evacuation')">대피거리 계산</button>
            <button class="tab" onclick="openTab('analysis')">의심물체 분석</button>
        </div>

        <!-- 대피거리 계산 탭 -->
        <div id="evacuation" class="tab-content active">
            <div class="input-section">
                <h3>용기 정보</h3>
                <select id="containerType">
                    <option value="">용기 종류 선택</option>
                    <option value="pipe">파이프 (1L)</option>
                    <option value="briefcase">서류가방 (15L)</option>
                    <option value="backpack">백팩 (20L)</option>
                    <option value="box">상자 (30L)</option>
                    <option value="suitcase">여행가방 (35L)</option>
                    <option value="drum">드럼통 (200L)</option>
                    <option value="carTrunk">승용차 트렁크 (500L)</option>
                    <option value="van">승합차 적재공간 (2500L)</option>
                    <option value="custom">직접 입력</option>
                </select>

                <div id="customVolumeInput" style="display: none;">
                    <input type="number" id="customWidth" placeholder="가로 (cm)" min="0" step="0.1">
                    <input type="number" id="customLength" placeholder="세로 (cm)" min="0" step="0.1">
                    <input type="number" id="customHeight" placeholder="높이 (cm)" min="0" step="0.1">
                </div>
            </div>

            <div class="input-section">
                <h3>폭발물 정보</h3>
                <select id="explosiveType">
                    <option value="">폭발물 종류 선택</option>
                    <option value="blackPowder">흑색화약 (밀도: 1.70 g/cm³)</option>
                    <option value="tnt">TNT (밀도: 1.654 g/cm³)</option>
                    <option value="c4">C4 (밀도: 1.72 g/cm³)</option>
                    <option value="semtex">Semtex (밀도: 1.55 g/cm³)</option>
                    <option value="anfo">ANFO (밀도: 0.84 g/cm³)</option>
                    <option value="dynamite">다이너마이트 (밀도: 1.60 g/cm³)</option>
                </select>
            </div>

            <div class="input-section">
                <h3>K-Factor 선택</h3>
                <select id="kFactor">
                    <option value="328.0">K = 328 (무반사 파괴 - Blast overpressure 1 psi 미만, 엄격한 민간 보호 수준)</option>
                    <option value="100.0">K = 100 (구조물 피해 방지, 일반적인 민간 및 경계 유지 수준)</option>
                    <option value="40.0">K = 40 (작전상 인명 피해 최소화 기준 - High risk, 군사 작전상 최소 안전거리 기준)</option>
                    <option value="24.0">K = 24 (중간 위험 구역 설정, 위험 감수 전제 작전 구역)</option>
                    <option value="10.0">K = 10 (폭발물 처리작전 중 접근 한계, EOD 장비 또는 인력 접근 가능한 수준)</option>
                    <option value="5.0" selected>K = 0~5 (극한 근접 작전 또는 확산시험 목적, 대부분 무인 작전 또는 실험 환경)</option>
                </select>
            </div>

            <button id="calculateBtn" class="calculate-btn">대피거리 계산</button>

            <div id="results-section" class="results-section show">
                <h3>분석 결과</h3>
                <div class="result-item">
                    <span>용기 부피:</span>
                    <strong>- L</strong>
                </div>
                <div class="result-item">
                    <span>예상 최대 폭발물 중량:</span>
                    <strong>- kg</strong>
                </div>
                <div class="result-item">
                    <span>TNT 당량:</span>
                    <strong>- kg (- lb)</strong>
                </div>
                <div class="result-item">
                    <span>권장 대피거리:</span>
                    <div class="distance-list">
                        <div class="distance-item">
                            <strong>- m</strong>
                            <span class="distance-desc">엄폐 후 방호 (최소 안전거리)</span>
                        </div>
                        <div class="distance-item">
                            <strong>- m</strong>
                            <span class="distance-desc">건물 내 대피</span>
                        </div>
                        <div class="distance-item">
                            <strong>- m</strong>
                            <span class="distance-desc">일반 대피 (최대 안전거리)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="map-container" style="display: block;">
                <div class="search-container">
                    <input type="text" id="searchLocation" class="search-input" placeholder="위치 검색 (예: 서울시청, 강남구청 등)">
                    <button id="searchBtn" class="location-btn">검색</button>
                    <button id="getCurrentLocation" class="location-btn">현재 위치</button>
                    <button id="drawCircleBtn" class="location-btn">대피 반경 표시</button>
                </div>
                <div id="map"></div>
                <div class="circle-legend">
                    <h4>대피 반경 범례</h4>
                    <div class="circle-legend-item">
                        <div class="circle-legend-color" style="background-color: rgba(255, 0, 0, 0.2)"></div>
                        <span>최대 안전거리 (일반 대피)</span>
                    </div>
                    <div class="circle-legend-item">
                        <div class="circle-legend-color" style="background-color: rgba(0, 255, 0, 0.2)"></div>
                        <span>최소 안전거리 (엄폐 후 방호)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 의심물체 분석 탭 -->
        <div id="analysis" class="tab-content">
            <div class="input-section">
                <h3>의심물체 사진</h3>
                <div class="image-upload-section">
                    <div class="image-upload-item">
                        <label for="realPhoto">실제 사진:</label>
                        <input type="file" id="realPhoto" accept="image/*">
                        <img id="realPhotoPreview" src="#" alt="실제 사진 미리보기" class="image-preview">
                    </div>
                    <div class="image-upload-item">
                        <label for="xrayPhoto">엑스레이 사진:</label>
                        <input type="file" id="xrayPhoto" accept="image/*">
                        <img id="xrayPhotoPreview" src="#" alt="엑스레이 사진 미리보기" class="image-preview">
                    </div>
                </div>
            </div>

            <div id="analysis-results" class="results-section show">
                <h3>분석 결과</h3>
                <div class="result-item">
                    <span>폭약:</span>
                    <input type="text" id="explosiveInput" placeholder="종류를 입력하세요">
                </div>
                <div class="result-item">
                    <span>기폭장치:</span>
                    <input type="text" id="detonatorInput" placeholder="종류를 입력하세요">
                </div>
                <div class="result-item">
                    <span>전원:</span>
                    <input type="text" id="powerInput" placeholder="종류를 입력하세요">
                </div>
                <div class="result-item">
                    <span>스위치:</span>
                    <input type="text" id="switchInput" placeholder="종류를 입력하세요">
                </div>
                <button id="savePdfBtn" class="calculate-btn" style="margin-top:10px;">데이터 저장</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 폭발물 데이터
        const explosivesData = {
            blackPowder: { density: 1.70, tntEquivalent: 0.55 },
            tnt: { density: 1.654, tntEquivalent: 1.00 },
            c4: { density: 1.72, tntEquivalent: 1.34 },
            semtex: { density: 1.55, tntEquivalent: 1.30 },
            anfo: { density: 0.84, tntEquivalent: 0.82 },
            dynamite: { density: 1.60, tntEquivalent: 0.92 }
        };

        // 미리 정의된 용기 부피 (리터 단위)
        const predefinedContainers = {
            pipe: 1,
            briefcase: 15,
            backpack: 20,
            box: 30,
            suitcase: 35,
            drum: 200,
            carTrunk: 500,
            van: 2500
        };

        let map = null;
        let currentMarker = null;
        let circles = [];

        // 지도 초기화 함수
        function initMap(lat, lng) {
            if (!map) {
                map = L.map('map').setView([lat, lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
            } else {
                map.setView([lat, lng], 15);
            }

            // 기존 마커 제거
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            // 새 마커 추가
            currentMarker = L.marker([lat, lng]).addTo(map);
        }

        // 대피 반경 그리기 함수
        function drawEvacuationCircles(lat, lng, distances) {
            // 기존 원 제거
            circles.forEach(circle => map.removeLayer(circle));
            circles = [];

            // 최대 안전거리 (빨간색)
            circles.push(L.circle([lat, lng], {
                radius: distances.general.distance,
                color: 'red',
                fillColor: '#ff0000',
                fillOpacity: 0.2
            }).addTo(map));

            // 최소 안전거리 (초록색)
            circles.push(L.circle([lat, lng], {
                radius: distances.protected.distance,
                color: 'green',
                fillColor: '#00ff00',
                fillOpacity: 0.2
            }).addTo(map));

            // 모든 원이 보이도록 지도 뷰 조정
            const bounds = L.latLngBounds([lat, lng]);
            // 대피 반경이 큰 원에 맞춰 지도 뷰 조정 (일반 대피)
            bounds.extend(L.latLng(lat, lng).toBounds(distances.general.distance * 2));
            map.fitBounds(bounds, { padding: [20, 20] });

            // 거리 표시 추가
            addDistanceLabels(lat, lng, distances.general.distance, '일반 대피', 'red');
            addDistanceLabels(lat, lng, distances.protected.distance, '엄폐 후 방호', 'green');
        }

        // 거리 표시 라벨 추가 함수
        function addDistanceLabels(lat, lng, distance, labelText, color) {
            // 원의 외곽에 대략적인 위치에 라벨 표시
            // 간단하게 동쪽 방향으로 라벨 추가
            const angle = 90 * Math.PI / 180; // 동쪽 방향 (라디안)
            const targetLat = lat + (distance / 111319.9) * Math.sin(angle);
            const targetLng = lng + (distance / (111319.9 * Math.cos(lat * Math.PI / 180))) * Math.cos(angle);

            const textMarker = L.marker([targetLat, targetLng], {
                icon: L.divIcon({
                    className: 'distance-label',
                    html: `<div style="white-space: nowrap; padding: 2px 5px; font-size: 12px; color: ${color}; font-weight: bold; text-shadow: 1px 1px 2px black;">${distance} m (${labelText})</div>`,
                    iconSize: [0, 0] // 아이콘 자체는 숨김
                })
            }).addTo(map);
            circles.push(textMarker); // circles 배열에 추가하여 관리 (삭제 시 함께 제거)
        }

        // 현재 위치 가져오기 버튼 이벤트
        document.getElementById('getCurrentLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        initMap(lat, lng);
                    },
                    function(error) {
                        alert('위치 정보를 가져올 수 없습니다: ' + error.message);
                        // 기본 위치 (서울시청)로 초기화
                        initMap(37.5665, 126.9780);
                    }
                );
            } else {
                alert('이 브라우저에서는 위치 정보를 지원하지 않습니다.');
                // 기본 위치 (서울시청)로 초기화
                initMap(37.5665, 126.9780);
            }
        });

        // 용기 종류 변경 처리
        document.getElementById('containerType').addEventListener('change', function() {
            const customVolumeInput = document.getElementById('customVolumeInput');
            customVolumeInput.style.display = this.value === 'custom' ? 'block' : 'none';
            
            if (this.value === 'custom') {
                document.getElementById('customWidth').value = '';
                document.getElementById('customLength').value = '';
                document.getElementById('customHeight').value = '';
            }
        });

        // 계산 버튼 클릭 이벤트
        document.getElementById('calculateBtn').addEventListener('click', function() {
            const containerType = document.getElementById('containerType').value;
            const explosiveType = document.getElementById('explosiveType').value;

            if (!containerType || !explosiveType) {
                alert('용기 종류와 폭발물 종류를 모두 선택해주세요.');
                return;
            }

            let volume = 0;
            if (containerType === 'custom') {
                const width = parseFloat(document.getElementById('customWidth').value);
                const length = parseFloat(document.getElementById('customLength').value);
                const height = parseFloat(document.getElementById('customHeight').value);

                if (!width || !length || !height) {
                    alert('가로, 세로, 높이를 모두 입력해주세요.');
                    return;
                }

                volume = (width * length * height) / 1000; // cm³ to L
            } else {
                volume = predefinedContainers[containerType];
            }

            const density = explosivesData[explosiveType].density;
            const maxWeight = volume * density;
            const tntEquivalent = maxWeight * explosivesData[explosiveType].tntEquivalent;

            const kFactors = {
                protected: { k: 12.0, desc: '엄폐 후 방호' },
                building: { k: 40.0, desc: '건물 내 대피' },
                general: { k: 50.0, desc: '일반 대피' }
            };

            const distances = {};
            for (const [key, value] of Object.entries(kFactors)) {
                distances[key] = {
                    distance: Math.ceil(value.k * Math.pow(tntEquivalent, 1/3)),
                    description: value.desc
                };
            }

            // 계산된 거리 저장
            lastCalculatedDistances = distances;

            const resultsSection = document.getElementById('results-section');
            const selectedK = parseFloat(document.getElementById('kFactor').value);
            const customDistance = Math.ceil(selectedK * Math.pow(tntEquivalent, 1/3));

            resultsSection.innerHTML = `
                <h3>분석 결과</h3>
                <div class="result-item">
                    <span>용기 부피:</span>
                    <strong>${volume.toFixed(2)} L</strong>
                </div>
                <div class="result-item">
                    <span>예상 최대 폭발물 중량:</span>
                    <strong>${maxWeight.toFixed(2)} kg</strong>
                </div>
                <div class="result-item">
                    <span>TNT 당량:</span>
                    <strong>${tntEquivalent.toFixed(2)} kg (${(tntEquivalent * 2.20462).toFixed(2)} lb)</strong>
                </div>
                <div class="result-item" style="background:#e9f7ef;">
                    <span style="font-weight:bold;">설정 대피거리:</span>
                    <strong>${customDistance} m</strong>
                    <span style="font-size:13px;display:block;margin-top:4px;">(계산식: ${selectedK} × (${tntEquivalent.toFixed(2)})⅓ = ${customDistance}m)</span>
                </div>
                <div class="result-item">
                    <span>권장 대피거리:</span>
                    <div class="distance-list">
                        <div class="distance-item">
                            <strong>${distances.protected.distance} m</strong>
                            <span class="distance-desc">${distances.protected.description} (계산식: 12 × (${tntEquivalent.toFixed(2)})⅓ = ${distances.protected.distance}m)</span>
                        </div>
                        <div class="distance-item">
                            <strong>${distances.building.distance} m</strong>
                            <span class="distance-desc">${distances.building.description} (계산식: 40 × (${tntEquivalent.toFixed(2)})⅓ = ${distances.building.distance}m)</span>
                        </div>
                        <div class="distance-item">
                            <strong>${distances.general.distance} m</strong>
                            <span class="distance-desc">${distances.general.description} (계산식: 50 × (${tntEquivalent.toFixed(2)})⅓ = ${distances.general.distance}m)</span>
                        </div>
                    </div>
                </div>
            `;
            // 결과 섹션은 이미 표시되어 있으므로 display 설정 불필요

            // 현재 위치에 대피 반경 표시
            if (currentMarker) {
                const latlng = currentMarker.getLatLng();
                drawEvacuationCircles(latlng.lat, latlng.lng, distances);
            } else {
                // 위치가 없는 경우 위치 가져오기 버튼 클릭
                document.getElementById('getCurrentLocation').click();
            }
        });

        // 위치 검색 함수 추가
        async function searchLocation(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.length > 0) {
                    const location = data[0];
                    const lat = parseFloat(location.lat);
                    const lng = parseFloat(location.lon);
                    
                    initMap(lat, lng);
                    
                    // 대피 반경이 이미 계산되어 있다면 새로운 위치에 표시
                    if (circles.length > 0) {
                        const resultsSection = document.getElementById('results-section');
                        if (resultsSection.style.display === 'block') {
                            const latlng = currentMarker.getLatLng();
                            drawEvacuationCircles(latlng.lat, latlng.lng, lastCalculatedDistances);
                        }
                    }
                } else {
                    alert('검색 결과를 찾을 수 없습니다.');
                }
            } catch (error) {
                alert('위치 검색 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 검색 버튼 이벤트 리스너
        document.getElementById('searchBtn').addEventListener('click', function() {
            const query = document.getElementById('searchLocation').value;
            if (query.trim()) {
                searchLocation(query);
            } else {
                alert('검색어를 입력해주세요.');
            }
        });

        // 검색 입력창 엔터 키 이벤트
        document.getElementById('searchLocation').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value;
                if (query.trim()) {
                    searchLocation(query);
                } else {
                    alert('검색어를 입력해주세요.');
                }
            }
        });

        let lastCalculatedDistances = null;

        // 페이지 로드 시 기본 위치(서울시청)로 지도 초기화
        window.addEventListener('load', function() {
            initMap(37.5665, 126.9780);

            // 지도 더블클릭 이벤트 추가
            map.on('dblclick', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                initMap(lat, lng);

                // 이전에 계산된 안전거리가 있다면 새로운 위치에 원 다시 그리기
                if (lastCalculatedDistances) {
                    drawEvacuationCircles(lat, lng, lastCalculatedDistances);
                }
            });
        });

        // 탭 전환 함수
        function openTab(tabName) {
            // 모든 탭 컨텐츠 숨기기
            const tabContents = document.getElementsByClassName('tab-content');
            for (let content of tabContents) {
                content.classList.remove('active');
            }

            // 모든 탭 버튼 비활성화
            const tabs = document.getElementsByClassName('tab');
            for (let tab of tabs) {
                tab.classList.remove('active');
            }

            // 선택된 탭 컨텐츠와 버튼 활성화
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // 이미지 파일 입력 변경 시 미리보기 업데이트 함수
        function setupImagePreview(inputId, imgId) {
            const input = document.getElementById(inputId);
            const img = document.getElementById(imgId);

            input.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        img.src = e.target.result;
                        img.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                } else {
                    img.src = '#';
                    img.style.display = 'none';
                }
            });
        }

        // 페이지 로드 후 이미지 미리보기 설정
        window.addEventListener('load', function() {
            setupImagePreview('realPhoto', 'realPhotoPreview');
            setupImagePreview('xrayPhoto', 'xrayPhotoPreview');
        });

        // PDF 저장 기능 (의심물체 분석)
        // 한글 폰트 내장
        if (window.jspdf && window.jspdf.jsPDF) {
            window.jspdf.jsPDF.API.events.push(['addFonts', function() {
                this.addFileToVFS('NanumGothic.ttf',
'AAEAAAASAQAABAAgR0RFRrRCsIIAAACcAAAAYGNtYXAWAAABHAAAADZnbHlmAAABuAAAABRnbHlmAAAB9AAAADZnbHlmAAACCAAAABRnbHlmAAACNAAAADZnbHlmAAACRAAAABRnbHlmAAACXAAAADZnbHlmAAACdAAAABRnbHlmAAACjAAAADZnbHlmAAACpAAAABRnbHlmAAACvAAAADZnbHlmAAAC1AAAABRnbHlmAAAC7AAAADZnbHlmAAADBAAAABRnbHlmAAADHAAAADZnbHlmAAADNAAAABRnbHlmAAADRAAAADZnbHlmAAADZAAAABRnbHlmAAADfAAAADZnbHlmAAADlAAAABRnbHlmAAADrAAAADZnbHlmAAADxAAAABRnbHlmAAAD3AAAADZnbHlmAAAEAAAAABRnbHlmAAAEGAAAADZnbHlmAAAEJAAAABRnbHlmAAAEQAAAADZnbHlmAAAEWAAAABRnbHlmAAAEcAAAADZnbHlmAAAEiAAAABRnbHlmAAAEoAAAADZnbHlmAAAEuAAAABRnbHlmAAAE0AAAADZnbHlmAAAE6AAAABRnbHlmAAAFBAAAADZnbHlmAAAFGAAAABRnbHlmAAAFMAAAADZnbHlmAAAFSAAAABRnbHlmAAAFWAAAADZnbHlmAAAFcAAAABRnbHlmAAAFiAAAADZnbHlmAAAFoAAAABRnbHlmAAAFuAAAADZnbHlmAAAF0AAAABRnbHlmAAAF6AAAADZnbHlmAAAGAAAAABRnbHlmAAAGGAAAADZnbHlmAAAGJAAAABRnbHlmAAAGQAAAADZnbHlmAAAGWAAAABRnbHlmAAAGcAAAADZnbHlmAAAGiAAAABRnbHlmAAAGoAAAADZnbHlmAAAGuAAAABRnbHlmAAAG0AAAADZnbHlmAAAG6AAAABRnbHlmAAAHBAAAADZnbHlmAAAHGAAAABRnbHlmAAAHMAAAADZnbHlmAAAHSAAAABRnbHlmAAAHWAAAADZnbHlmAAAHcAAAABRnbHlmAAAHiAAAADZnbHlmAAAHoAAAABRnbHlmAAAHuAAAADZnbHlmAAAH0AAAABRnbHlmAAAH6AAAADZnbHlmAAAI...');
                this.addFont('NanumGothic.ttf', 'NanumGothic', 'normal');
            }]);
        }
        document.getElementById('savePdfBtn').addEventListener('click', function() {
            const explosive = document.getElementById('explosiveInput').value;
            const detonator = document.getElementById('detonatorInput').value;
            const power = document.getElementById('powerInput').value;
            const sw = document.getElementById('switchInput').value;
            const realPhoto = document.getElementById('realPhoto').files[0];
            const xrayPhoto = document.getElementById('xrayPhoto').files[0];

            let doc = new window.jspdf.jsPDF();
            doc.setFont('NanumGothic');
            doc.setFontSize(16);
            doc.text('의심물체 분석 결과', 10, 15);
            doc.setFontSize(12);
            let y = 30;
            doc.text(`폭약: ${explosive}`, 10, y); y += 10;
            doc.text(`기폭장치: ${detonator}`, 10, y); y += 10;
            doc.text(`전원: ${power}`, 10, y); y += 10;
            doc.text(`스위치: ${sw}`, 10, y); y += 10;
            if(realPhoto) { doc.text(`실제 사진: ${realPhoto.name}`, 10, y); y += 10; }
            if(xrayPhoto) { doc.text(`엑스레이 사진: ${xrayPhoto.name}`, 10, y); y += 10; }
            doc.save('의심물체_분석.pdf');
        });
    </script>
</body>
</html> 