<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경찰특공대 EOD 분석시스템</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas CDN 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #ffffff;
            --accent-color: #007bff;
            --background-color: #f8f9fa;
            --text-color: #212529;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "맑은 고딕", sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
        }
        
        .header {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            padding: 1rem;
            text-align: center;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .input-section {
            background-color: var(--secondary-color);
            padding: 16px;
            margin-bottom: 14px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.07);
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 10px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            min-height: 36px;
        }
        
        .results-section {
            display: none;
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .results-section.show {
            display: block;
        }
        
        .result-item {
            margin-bottom: 15px;
            padding: 15px;
            background-color: var(--background-color);
            border-radius: 4px;
        }
        
        .result-item strong {
            color: var(--accent-color);
            font-size: 1.2em;
        }

        /* 지도 관련 스타일 추가 */
        #map-container {
            margin-top: 20px;
            display: none;
        }

        #map {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .location-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            min-height: 32px;
            font-size: 15px;
            white-space: nowrap;
        }

        .circle-legend {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--background-color);
            border-radius: 4px;
        }

        .circle-legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .circle-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* 검색 컨테이너 스타일 추가 */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .search-input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        /* 탭 스타일 추가 */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }

        .tab {
            padding: 12px 24px;
            background-color: var(--background-color);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .tab.active {
            background-color: var(--primary-color);
            color: var(--secondary-color);
        }

        .tab:hover {
            background-color: #e9ecef;
        }

        .tab.active:hover {
            background-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 의심물체 분석 페이지 스타일 */
        .analysis-form {
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .analysis-item {
            background-color: var(--background-color);
            padding: 15px;
            border-radius: 4px;
        }

        .analysis-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .analysis-item select,
        .analysis-item input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* 분석 탭 이미지 업로드 섹션 스타일 */
        .image-upload-section {
            display: flex;
            gap: 20px; /* 사진 사이 간격 */
            margin-top: 15px;
        }

        .image-upload-item {
            flex: 1; /* 공간 균등 분할 */
            display: flex;
            flex-direction: column;
        }

        .image-upload-item label {
            margin-bottom: 8px;
            font-weight: bold;
        }

        .image-upload-item input[type="file"] {
            margin-bottom: 10px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 600px; /* 미리보기 최대 높이 제한 */
            height: auto;
            display: none; /* 초기에는 숨김 */
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* 반응형 */
        @media (max-width: 600px) {
            body {
                padding: 2px;
            }
            .container {
                max-width: 100vw;
                padding: 2px;
            }
            .header {
                padding: 0.5rem;
                font-size: 1.1em;
            }
            .header h1 {
                font-size: 1.05em;
                white-space: nowrap;
                overflow-x: auto;
            }
            .tabs {
                margin-bottom: 10px;
            }
            .tab {
                padding: 8px 8px;
                font-size: 13px;
            }
            .tab-content {
                padding: 0;
            }
            .input-section, .results-section {
                padding: 7px 4px;
                margin-bottom: 7px;
                font-size: 13px;
            }
            h3 {
                font-size: 1em;
                margin: 8px 0 6px 0;
            }
            select, input[type="number"], input[type="text"] {
                padding: 6px;
                font-size: 13px;
                margin-bottom: 6px;
            }
            .calculate-btn {
                padding: 6px 0;
                font-size: 13px;
                min-height: 26px;
                width: 100%;
            }
            .location-btn {
                padding: 3px 5px;
                font-size: 11px;
                min-height: 18px;
                width: auto;
                white-space: nowrap;
            }
            .search-container {
                flex-wrap: wrap;
                gap: 2px;
                margin-bottom: 4px;
            }
            .search-input {
                font-size: 12px;
                padding: 5px;
            }
            .result-item {
                padding: 8px 4px;
                font-size: 13px;
            }
            /* 아래 추가: 사진 업로드 영역 세로 배치 및 이미지 크기 조정 */
            .image-upload-section {
                flex-direction: column;
                gap: 8px;
            }
            .image-upload-item {
                width: 100%;
            }
            .image-preview {
                max-width: 100vw;
                width: 100%;
                height: auto;
                max-height: 320px;
                display: block;
                margin: 0 auto;
            }
            .image-upload-section {
                margin-top: 8px;
            }
            .image-preview {
                border-radius: 4px;
            }
            #map {
                height: 220px;
                min-height: 120px;
            }
            .circle-legend {
                padding: 6px;
                font-size: 12px;
            }
            .container-manual-row {
                gap: 4px;
                margin-top: 6px;
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            .container-manual-row label {
                font-size: 12px;
                min-width: 22px;
            }
            .container-manual-row input[type="number"] {
                width: 32px;
                font-size: 12px;
                padding: 2px 2px;
            }
            #customVolumeResult {
                font-size: 11px;
                margin-left: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>경찰특공대 EOD 분석시스템</h1>
    </div>

    <div class="container">
        <!-- 탭 버튼 -->
        <div class="tabs">
            <button class="tab active" onclick="openTab('evacuation')">대피거리 계산</button>
            <button class="tab" onclick="openTab('analysis')">의심물체 분석</button>
        </div>

        <!-- 대피거리 계산 탭 -->
        <div id="evacuation" class="tab-content active">
            <div class="input-section">
                <h3>용기 정보</h3>
                <label for="containerType">용기 종류</label>
                <select id="containerType">
                    <option value="">용기 종류 선택</option>
                    <option value="pipe">파이프 (1L)</option>
                    <option value="briefcase">서류가방 (15L)</option>
                    <option value="backpack">백팩 (20L)</option>
                    <option value="box">상자 (30L)</option>
                    <option value="suitcase">여행가방 (35L)</option>
                    <option value="drum">드럼통 (200L)</option>
                    <option value="carTrunk">승용차 트렁크 (500L)</option>
                    <option value="van">승합차 적재공간 (2500L)</option>
                </select>

                <div class="container-manual-row" style="display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap;">
                    <label for="customWidth" style="margin-bottom:0;">가로(cm)</label>
                    <input type="number" id="customWidth" min="0" step="0.1" style="width:70px;">
                    <label for="customLength" style="margin-bottom:0;">세로(cm)</label>
                    <input type="number" id="customLength" min="0" step="0.1" style="width:70px;">
                    <label for="customHeight" style="margin-bottom:0;">높이(cm)</label>
                    <input type="number" id="customHeight" min="0" step="0.1" style="width:70px;">
                    <span id="customVolumeResult" style="margin-left:10px;font-weight:bold;color:#03c75a;"></span>
                </div>
            </div>

            <div class="input-section">
                <h3>폭발물 정보</h3>
                <select id="explosiveType">
                    <option value="">폭발물 종류 선택</option>
                    <option value="blackPowder">흑색화약 (밀도: 1.70 g/cm³)</option>
                    <option value="tnt">TNT (밀도: 1.654 g/cm³)</option>
                    <option value="c4">C4 (밀도: 1.72 g/cm³)</option>
                    <option value="semtex">Semtex (밀도: 1.55 g/cm³)</option>
                    <option value="anfo">ANFO (밀도: 0.84 g/cm³)</option>
                    <option value="dynamite">다이너마이트 (밀도: 1.60 g/cm³)</option>
                </select>
            </div>

            <div class="input-section">
                <h3>K-Factor 선택</h3>
                <select id="kFactor">
                    <option value="328.0">K = 328 (무반사 파괴 - Blast overpressure 1 psi 미만, 엄격한 민간 보호 수준)</option>
                    <option value="100.0" selected>K = 100 (구조물 피해 방지, 일반적인 민간 및 경계 유지 수준)</option>
                    <option value="40.0">K = 40 (작전상 인명 피해 최소화 기준 - High risk, 군사 작전상 최소 안전거리 기준)</option>
                    <option value="24.0">K = 24 (중간 위험 구역 설정, 위험 감수 전제 작전 구역)</option>
                    <option value="10.0">K = 10 (폭발물 처리작전 중 접근 한계, EOD 장비 또는 인력 접근 가능한 수준)</option>
                    <option value="5.0">K = 0~5 (극한 근접 작전 또는 확산시험 목적, 대부분 무인 작전 또는 실험 환경)</option>
                </select>
            </div>

            <button id="calculateBtn" class="calculate-btn">대피거리 계산</button>

            <div id="results-section" class="results-section show">
                <h3>분석 결과</h3>
                <div class="result-item">
                    <span>용기 부피:</span>
                    <strong>- L</strong>
                </div>
                <div class="result-item">
                    <span>예상 최대 폭발물 중량:</span>
                    <strong>- kg</strong>
                </div>
                <div class="result-item">
                    <span>TNT 당량:</span>
                    <strong>- kg (- lb)</strong>
                </div>
                <div class="result-item">
                    <span>권장 대피거리:</span>
                    <div class="distance-list">
                        <div class="distance-item">
                            <strong>- m</strong>
                            <span class="distance-desc">엄폐 후 방호 (최소 안전거리)</span>
                        </div>
                        <div class="distance-item">
                            <strong>- m</strong>
                            <span class="distance-desc">건물 내 대피</span>
                        </div>
                        <div class="distance-item">
                            <strong>- m</strong>
                            <span class="distance-desc">일반 대피 (최대 안전거리)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="map-container" style="display: block;">
                <div class="search-container">
                    <input type="text" id="searchLocation" class="search-input" placeholder="위치 검색 (예: 서울시청, 강남구청 등)">
                    <button id="searchBtn" class="location-btn">검색</button>
                    <button id="getCurrentLocation" class="location-btn">현재 위치</button>
                    <button id="drawCircleBtn" class="location-btn">대피 반경 표시</button>
                </div>
                <div id="map"></div>
                <div class="circle-legend">
                    <h4>대피 반경 범례</h4>
                    <div class="circle-legend-item">
                        <div class="circle-legend-color" style="background-color: rgba(255, 0, 0, 0.2)"></div>
                        <span>최대 안전거리 (일반 대피)</span>
                    </div>
                    <div class="circle-legend-item">
                        <div class="circle-legend-color" style="background-color: rgba(0, 255, 0, 0.2)"></div>
                        <span>최소 안전거리 (엄폐 후 방호)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 의심물체 분석 탭 -->
        <div id="analysis" class="tab-content">
            <div class="input-section">
                <h3>의심물체 사진</h3>
                <div class="image-upload-section">
                    <div class="image-upload-item">
                        <label for="realPhoto">실제 사진:</label>
                        <input type="file" id="realPhoto" accept="image/*">
                        <img id="realPhotoPreview" src="#" alt="실제 사진 미리보기" class="image-preview">
                    </div>
                    <div class="image-upload-item">
                        <label for="xrayPhoto">엑스레이 사진:</label>
                        <input type="file" id="xrayPhoto" accept="image/*">
                        <img id="xrayPhotoPreview" src="#" alt="" class="image-preview">
                    </div>
                </div>
            </div>

            <div id="analysis-results" class="results-section show">
                <h3>분석 결과</h3>
                <div class="result-item">
                    <span>폭약:</span>
                    <input type="text" id="explosiveInput" placeholder="종류를 입력하세요">
                </div>
                <div class="result-item">
                    <span>기폭장치:</span>
                    <input type="text" id="detonatorInput" placeholder="종류를 입력하세요">
                </div>
                <div class="result-item">
                    <span>전원:</span>
                    <input type="text" id="powerInput" placeholder="종류를 입력하세요">
                </div>
                <div class="result-item">
                    <span>스위치:</span>
                    <input type="text" id="switchInput" placeholder="종류를 입력하세요">
                </div>
                <button id="savePdfBtn" class="calculate-btn" style="margin-top:10px;">데이터 저장</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 폭발물 데이터
        const explosivesData = {
            blackPowder: { density: 1.70, tntEquivalent: 0.55 },
            tnt: { density: 1.654, tntEquivalent: 1.00 },
            c4: { density: 1.72, tntEquivalent: 1.34 },
            semtex: { density: 1.55, tntEquivalent: 1.30 },
            anfo: { density: 0.84, tntEquivalent: 0.82 },
            dynamite: { density: 1.60, tntEquivalent: 0.92 }
        };

        // 미리 정의된 용기 부피 (리터 단위)
        const predefinedContainers = {
            pipe: 1,
            briefcase: 15,
            backpack: 20,
            box: 30,
            suitcase: 35,
            drum: 200,
            carTrunk: 500,
            van: 2500
        };

        let map = null;
        let currentMarker = null;
        let circles = [];

        // 지도 초기화 함수
        function initMap(lat, lng) {
            if (!map) {
                map = L.map('map').setView([lat, lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
            } else {
                map.setView([lat, lng], 15);
            }

            // 기존 마커 제거
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            // 새 마커 추가
            currentMarker = L.marker([lat, lng]).addTo(map);
        }

        // 대피 반경 그리기 함수
        function drawEvacuationCircles(lat, lng, distances) {
            // 기존 원 제거
            circles.forEach(circle => map.removeLayer(circle));
            circles = [];

            // 최대 안전거리 (빨간색)
            circles.push(L.circle([lat, lng], {
                radius: distances.general.distance,
                color: 'red',
                fillColor: '#ff0000',
                fillOpacity: 0.2
            }).addTo(map));

            // 최소 안전거리 (초록색)
            circles.push(L.circle([lat, lng], {
                radius: distances.protected.distance,
                color: 'green',
                fillColor: '#00ff00',
                fillOpacity: 0.2
            }).addTo(map));

            // 모든 원이 보이도록 지도 뷰 조정
            const bounds = L.latLngBounds([lat, lng]);
            // 대피 반경이 큰 원에 맞춰 지도 뷰 조정 (일반 대피)
            bounds.extend(L.latLng(lat, lng).toBounds(distances.general.distance * 2));
            map.fitBounds(bounds, { padding: [20, 20] });

            // 거리 표시 추가
            addDistanceLabels(lat, lng, distances.general.distance, '일반 대피', 'red');
            addDistanceLabels(lat, lng, distances.protected.distance, '엄폐 후 방호', 'green');
        }

        // 거리 표시 라벨 추가 함수
        function addDistanceLabels(lat, lng, distance, labelText, color) {
            // 원의 외곽에 대략적인 위치에 라벨 표시
            // 간단하게 동쪽 방향으로 라벨 추가
            const angle = 90 * Math.PI / 180; // 동쪽 방향 (라디안)
            const targetLat = lat + (distance / 111319.9) * Math.sin(angle);
            const targetLng = lng + (distance / (111319.9 * Math.cos(lat * Math.PI / 180))) * Math.cos(angle);

            const textMarker = L.marker([targetLat, targetLng], {
                icon: L.divIcon({
                    className: 'distance-label',
                    html: `<div style="white-space: nowrap; padding: 2px 5px; font-size: 12px; color: ${color}; font-weight: bold; text-shadow: 1px 1px 2px black;">${distance} m (${labelText})</div>`,
                    iconSize: [0, 0] // 아이콘 자체는 숨김
                })
            }).addTo(map);
            circles.push(textMarker); // circles 배열에 추가하여 관리 (삭제 시 함께 제거)
        }

        // 대피반경 토글 상태 변수
        let isEvacuationCircleVisible = false;
        let lastEvacuationCircleData = null;

        // 대피 반경 표시 버튼 이벤트 리스너 (토글)
        document.getElementById('drawCircleBtn').addEventListener('click', function() {
            if (!currentMarker) {
                alert('먼저 지도에 위치를 설정해주세요 (검색 또는 현재 위치).');
                return;
            }
            if (!lastCalculatedDistances) {
                alert('먼저 대피 거리를 계산해주세요.');
                return;
            }
            const latlng = currentMarker.getLatLng();
            if (!isEvacuationCircleVisible) {
                drawEvacuationCircles(latlng.lat, latlng.lng, lastCalculatedDistances);
                isEvacuationCircleVisible = true;
                lastEvacuationCircleData = {lat: latlng.lat, lng: latlng.lng, distances: lastCalculatedDistances};
            } else {
                // 반경 제거
                if (typeof circles !== 'undefined' && Array.isArray(circles)) {
                    circles.forEach(circle => map.removeLayer(circle));
                    circles = [];
                }
                isEvacuationCircleVisible = false;
            }
        });

        // 현재 위치 버튼 클릭 시 반경은 사라지지만, drawCircleBtn을 누르면 다시 표시 가능
        document.getElementById('getCurrentLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    setMarkerPosition(position.coords.latitude, position.coords.longitude);
                    // 반경은 숨김 상태로 전환
                    if (typeof circles !== 'undefined' && Array.isArray(circles)) {
                        circles.forEach(circle => map.removeLayer(circle));
                        circles = [];
                    }
                    isEvacuationCircleVisible = false;
                });
            }
        });

        // 용기 종류 변경 처리
        document.getElementById('containerType').addEventListener('change', function() {
            const customVolumeInput = document.getElementById('customVolumeInput');
            customVolumeInput.style.display = this.value === 'custom' ? 'block' : 'none';
            
            if (this.value === 'custom') {
                document.getElementById('customWidth').value = '';
                document.getElementById('customLength').value = '';
                document.getElementById('customHeight').value = '';
            }
        });

        // 계산 버튼 클릭 이벤트
        document.getElementById('calculateBtn').addEventListener('click', function() {
            // 1. 용기 종류 선택값
            const containerType = document.getElementById('containerType').value;
            // 2. 직접입력값
            const w = parseFloat(document.getElementById('customWidth').value);
            const l = parseFloat(document.getElementById('customLength').value);
            const h = parseFloat(document.getElementById('customHeight').value);
            let volumeL = null;

            // 용기 종류별 부피(리터) 매핑
            const containerVolumes = {
                pipe: 1,
                briefcase: 15,
                backpack: 20,
                box: 30,
                suitcase: 35,
                drum: 200,
                carTrunk: 500,
                van: 2500
            };

            if (containerType && containerVolumes[containerType]) {
                volumeL = containerVolumes[containerType];
            } else if (!containerType && !isNaN(w) && !isNaN(l) && !isNaN(h) && w > 0 && l > 0 && h > 0) {
                // 직접입력값이 모두 유효하면 직접입력 부피 사용
                const volumeCm3 = w * l * h;
                volumeL = volumeCm3 / 1000;
            }

            if (volumeL === null) {
                alert('용기 종류를 선택하거나 직접 가로/세로/높이를 입력해 주세요.');
                return;
            }

            const explosiveType = document.getElementById('explosiveType').value;

            if (!explosiveType) {
                alert('폭발물 종류를 선택해주세요.');
                return;
            }

            const density = explosivesData[explosiveType].density;
            const maxWeight = volumeL * density;
            const tntEquivalent = maxWeight * explosivesData[explosiveType].tntEquivalent;

            const kFactors = {
                protected: { k: 12.0, desc: '엄폐 후 방호' },
                building: { k: 40.0, desc: '건물 내 대피' },
                general: { k: 50.0, desc: '일반 대피' }
            };

            const distances = {};
            for (const [key, value] of Object.entries(kFactors)) {
                distances[key] = {
                    distance: Math.ceil(value.k * Math.pow(tntEquivalent, 1/3)),
                    description: value.desc
                };
            }

            // 계산된 거리 저장
            lastCalculatedDistances = distances;

            const resultsSection = document.getElementById('results-section');
            const selectedK = parseFloat(document.getElementById('kFactor').value);
            const customDistance = Math.ceil(selectedK * Math.pow(tntEquivalent, 1/3));

            resultsSection.innerHTML = `
                <h3>분석 결과</h3>
                <div class="result-item">
                    <span>용기 부피:</span>
                    <strong>${volumeL.toFixed(2)} L</strong>
                </div>
                <div class="result-item">
                    <span>예상 최대 폭발물 중량:</span>
                    <strong>${maxWeight.toFixed(2)} kg</strong>
                </div>
                <div class="result-item">
                    <span>TNT 당량:</span>
                    <strong>${tntEquivalent.toFixed(2)} kg (${(tntEquivalent * 2.20462).toFixed(2)} lb)</strong>
                </div>
                <div class="result-item" style="background:#e9f7ef;">
                    <span style="font-weight:bold;">설정 대피거리:</span>
                    <strong>${customDistance} m</strong>
                    <span style="font-size:13px;display:block;margin-top:4px;">(계산식: ${selectedK} × (${tntEquivalent.toFixed(2)})⅓ = ${customDistance}m)</span>
                </div>
                <div class="result-item">
                    <span>권장 대피거리:</span>
                    <div class="distance-list">
                        <div class="distance-item">
                            <strong>${distances.protected.distance} m</strong>
                            <span class="distance-desc">${distances.protected.description} (계산식: 12 × (${tntEquivalent.toFixed(2)})⅓ = ${distances.protected.distance}m)</span>
                        </div>
                        <div class="distance-item">
                            <strong>${distances.building.distance} m</strong>
                            <span class="distance-desc">${distances.building.description} (계산식: 40 × (${tntEquivalent.toFixed(2)})⅓ = ${distances.building.distance}m)</span>
                        </div>
                        <div class="distance-item">
                            <strong>${distances.general.distance} m</strong>
                            <span class="distance-desc">${distances.general.description} (계산식: 50 × (${tntEquivalent.toFixed(2)})⅓ = ${distances.general.distance}m)</span>
                        </div>
                    </div>
                </div>
            `;
            // 결과 섹션은 이미 표시되어 있으므로 display 설정 불필요

            // 현재 위치에 대피 반경 표시
            if (currentMarker) {
                const latlng = currentMarker.getLatLng();
                drawEvacuationCircles(latlng.lat, latlng.lng, distances);
            } else {
                // 위치가 없는 경우 위치 가져오기 버튼 클릭
                document.getElementById('getCurrentLocation').click();
            }
        });

        // 위치 검색 함수 추가
        async function searchLocation(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.length > 0) {
                    const location = data[0];
                    const lat = parseFloat(location.lat);
                    const lng = parseFloat(location.lon);
                    
                    initMap(lat, lng);
                    
                    // 대피 반경이 이미 계산되어 있다면 새로운 위치에 표시
                    if (circles.length > 0) {
                        const resultsSection = document.getElementById('results-section');
                        if (resultsSection.style.display === 'block') {
                            const latlng = currentMarker.getLatLng();
                            drawEvacuationCircles(latlng.lat, latlng.lng, lastCalculatedDistances);
                        }
                    }
                } else {
                    alert('검색 결과를 찾을 수 없습니다.');
                }
            } catch (error) {
                alert('위치 검색 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 검색 버튼 이벤트 리스너
        document.getElementById('searchBtn').addEventListener('click', function() {
            const query = document.getElementById('searchLocation').value;
            if (query.trim()) {
                searchLocation(query);
            } else {
                alert('검색어를 입력해주세요.');
            }
        });

        // 검색 입력창 엔터 키 이벤트
        document.getElementById('searchLocation').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value;
                if (query.trim()) {
                    searchLocation(query);
                } else {
                    alert('검색어를 입력해주세요.');
                }
            }
        });

        let lastCalculatedDistances = null;

        // 페이지 로드 시 기본 위치(서울시청)로 지도 초기화
        window.addEventListener('load', function() {
            initMap(37.5665, 126.9780);

            // 지도 더블클릭 이벤트 추가
            map.on('dblclick', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                initMap(lat, lng);

                // 이전에 계산된 안전거리가 있다면 새로운 위치에 원 다시 그리기
                if (lastCalculatedDistances) {
                    drawEvacuationCircles(lat, lng, lastCalculatedDistances);
                }
            });
        });

        // 탭 전환 함수
        function openTab(tabName) {
            // 모든 탭 컨텐츠 숨기기
            const tabContents = document.getElementsByClassName('tab-content');
            for (let content of tabContents) {
                content.classList.remove('active');
            }

            // 모든 탭 버튼 비활성화
            const tabs = document.getElementsByClassName('tab');
            for (let tab of tabs) {
                tab.classList.remove('active');
            }

            // 선택된 탭 컨텐츠와 버튼 활성화
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // 이미지 파일 입력 변경 시 미리보기 업데이트 함수
        function setupImagePreview(inputId, imgId) {
            const input = document.getElementById(inputId);
            const img = document.getElementById(imgId);

            input.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        img.src = e.target.result;
                        img.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                } else {
                    img.src = '#';
                    img.style.display = 'none';
                }
            });
        }

        // 페이지 로드 후 이미지 미리보기 설정
        window.addEventListener('load', function() {
            setupImagePreview('realPhoto', 'realPhotoPreview');
            setupImagePreview('xrayPhoto', 'xrayPhotoPreview');
        });

        // PDF 저장 기능 (의심물체 분석)
        // 한글 폰트 내장
        if (window.jspdf && window.jspdf.jsPDF) {
            window.jspdf.jsPDF.API.events.push(['addFonts', function() {
                this.addFileToVFS('NanumGothic.ttf',
'AAEAAAASAQAABAAgR0RFRrRCsIIAAACcAAAAYGNtYXAWAAABHAAAADZnbHlmAAABuAAAABRnbHlmAAAB9AAAADZnbHlmAAACCAAAABRnbHlmAAACNAAAADZnbHlmAAACRAAAABRnbHlmAAACXAAAADZnbHlmAAACdAAAABRnbHlmAAACjAAAADZnbHlmAAACpAAAABRnbHlmAAACvAAAADZnbHlmAAAC1AAAABRnbHlmAAAC7AAAADZnbHlmAAADBAAAABRnbHlmAAADHAAAADZnbHlmAAADNAAAABRnbHlmAAADRAAAADZnbHlmAAADZAAAABRnbHlmAAADfAAAADZnbHlmAAADlAAAABRnbHlmAAADrAAAADZnbHlmAAADxAAAABRnbHlmAAAD3AAAADZnbHlmAAAEAAAAABRnbHlmAAAEGAAAADZnbHlmAAAEJAAAABRnbHlmAAAEQAAAADZnbHlmAAAEWAAAABRnbHlmAAAEcAAAADZnbHlmAAAEiAAAABRnbHlmAAAEoAAAADZnbHlmAAAEuAAAABRnbHlmAAAE0AAAADZnbHlmAAAE6AAAABRnbHlmAAAFBAAAADZnbHlmAAAFGAAAABRnbHlmAAAFMAAAADZnbHlmAAAFSAAAABRnbHlmAAAFWAAAADZnbHlmAAAFcAAAABRnbHlmAAAFiAAAADZnbHlmAAAFoAAAABRnbHlmAAAFuAAAADZnbHlmAAAF0AAAABRnbHlmAAAF6AAAADZnbHlmAAAGAAAAABRnbHlmAAAGGAAAADZnbHlmAAAGJAAAABRnbHlmAAAGQAAAADZnbHlmAAAGWAAAABRnbHlmAAAGcAAAADZnbHlmAAAGiAAAABRnbHlmAAAGoAAAADZnbHlmAAAGuAAAADZnbHlmAAAG0AAAADZnbHlmAAAG6AAAABRnbHlmAAAHBAAAADZnbHlmAAAHGAAAABRnbHlmAAAHMAAAADZnbHlmAAAHSAAAABRnbHlmAAAHWAAAADZnbHlmAAAHcAAAABRnbHlmAAAHiAAAADZnbHlmAAAHoAAAABRnbHlmAAAHuAAAADZnbHlmAAAH0AAAABRnbHlmAAAH6AAAADZnbHlmAAAI...');
                this.addFont('NanumGothic.ttf', 'NanumGothic', 'normal');
            }]);
        }
        document.getElementById('savePdfBtn').addEventListener('click', async function() {
            // PDF 저장 대신 스크린샷 저장
            const analysisTab = document.getElementById('analysis');
            html2canvas(analysisTab, {useCORS: true, backgroundColor: '#fff'}).then(function(canvas) {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = '의심물체_분석.png';
                link.click();
            });
        });

        // 직접입력 가로/세로/높이 입력 시 부피 자동 계산
        function updateCustomVolume() {
            const w = parseFloat(document.getElementById('customWidth').value);
            const l = parseFloat(document.getElementById('customLength').value);
            const h = parseFloat(document.getElementById('customHeight').value);
            const resultSpan = document.getElementById('customVolumeResult');
            if (!isNaN(w) && !isNaN(l) && !isNaN(h) && w > 0 && l > 0 && h > 0) {
                const volumeCm3 = w * l * h;
                const volumeL = volumeCm3 / 1000;
                resultSpan.textContent = `부피: ${volumeCm3.toLocaleString()} ㎤ (${volumeL.toLocaleString(undefined, {maximumFractionDigits:2})} L)`;
            } else {
                resultSpan.textContent = '';
            }
        }
        ['customWidth','customLength','customHeight'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateCustomVolume);
        });

        function setMarkerPosition(lat, lng) {
            // 기존 마커 제거
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            // 새 마커 추가
            currentMarker = L.marker([lat, lng]).addTo(map);

            // 지도 중심 이동 추가
            map.setView([lat, lng], 15);

            // 좌표 입력란, 주소 등 추가 갱신 코드...
            // (기존 코드 유지)
        }

        // 엑스레이 사진 위에 마커 표시 기능
        function ensureXrayMarkerContainer() {
            const previewImg = document.getElementById('xrayPhotoPreview');
            let container = previewImg.parentElement.querySelector('.xray-marker-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'xray-marker-container';
                previewImg.parentElement.style.position = 'relative';
                previewImg.parentElement.appendChild(container);
            }
            
            // 이미지의 실제 위치와 크기로 컨테이너 설정
            const imgRect = previewImg.getBoundingClientRect();
            const parentRect = previewImg.parentElement.getBoundingClientRect();
            
            container.style.position = 'absolute';
            container.style.left = (imgRect.left - parentRect.left) + 'px';
            container.style.top = (imgRect.top - parentRect.top) + 'px';
            container.style.width = imgRect.width + 'px';
            container.style.height = imgRect.height + 'px';
            container.style.pointerEvents = 'none';
            
            return container;
        }

        // 이미지 로드/리사이즈 시 컨테이너 크기 갱신
        const xrayImg = document.getElementById('xrayPhotoPreview');
        xrayImg.addEventListener('load', function() {
            ensureXrayMarkerContainer();
        });
        window.addEventListener('resize', function() {
            ensureXrayMarkerContainer();
        });

        function addXrayMarker(x, y) {
            const previewImg = document.getElementById('xrayPhotoPreview');
            const container = ensureXrayMarkerContainer();
            const markerSize = 18;
            const marker = document.createElement('div');
            marker.className = 'xray-marker-dot';
            marker.style.position = 'absolute';
            marker.style.width = markerSize + 'px';
            marker.style.height = markerSize + 'px';
            marker.style.borderRadius = '50%';
            marker.style.background = 'transparent';
            marker.style.border = '1.5px solid #ff3333';
            marker.style.boxShadow = '0 0 4px #ff3333, 0 0 2px #fff';
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            marker.style.transform = 'translate(-50%, -50%)';
            marker.style.pointerEvents = 'auto';
            marker.title = '더블클릭 위치';
            
            marker.addEventListener('click', function(e) {
                e.stopPropagation();
                container.removeChild(marker);
            });
            container.appendChild(marker);
        }

        // 엑스레이 사진 더블클릭 이벤트
        xrayImg.addEventListener('dblclick', function(e) {
            const rect = xrayImg.getBoundingClientRect();
            // 이미지 내부에서의 정확한 좌표 계산
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            addXrayMarker(x, y);
        });

        // 스타일 추가
        const style = document.createElement('style');
        style.innerHTML = `
        .xray-marker-container { pointer-events: none; position: absolute; left:0; top:0; }
        .xray-marker-dot { pointer-events: auto; transition: transform 0.1s; cursor: pointer; }
        .xray-marker-dot:hover { transform: scale(1.2); border-color: #ff0000; }
        #xrayPhotoPreview { display: block !important; vertical-align: top !important; }
`;
        document.head.appendChild(style);
    </script>
</body>
</html> 